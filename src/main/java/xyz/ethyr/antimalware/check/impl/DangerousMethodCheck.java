package xyz.ethyr.antimalware.check.impl;

import java.util.Arrays;
import org.objectweb.asm.tree.MethodInsnNode;
import org.objectweb.asm.tree.TypeInsnNode;
import xyz.ethyr.antimalware.AntiMalware.Plugin;
import xyz.ethyr.antimalware.check.Check;
import xyz.ethyr.antimalware.helper.BlockHelper;

public class DangerousMethodCheck implements Check {

  /*
  Shoud i recode this? xd
   */

  @Override
  public void check(Plugin plugin) {
    plugin.getClasses().forEach(classNode -> classNode.methods.stream()
        .flatMap(methodNode -> Arrays.stream(methodNode.instructions.toArray()))
        .filter(node -> node instanceof MethodInsnNode || node instanceof TypeInsnNode)
        .forEach(node -> {
          if (node instanceof MethodInsnNode) {
            MethodInsnNode method = (MethodInsnNode) node;
            String name = method.owner + "." + method.name;

            if (BlockHelper.isBlacklistedMethod(name)) {
              plugin.addLog(classNode.name + " -> Trying to invoke dangerous method: " + name);
            } else if (name.startsWith("net/minecraft/server/") && name
                .endsWith("/MinecraftServer.safeShutdown")) {
              plugin.addLog(classNode.name + " -> Trying to invoke dangerous method: " + name);
            } else if (name.endsWith("Player.setOp")) {
              plugin.addLog(classNode.name + " -> Trying to invoke dangerous method: " + name);
            }
          } else {
            TypeInsnNode type = (TypeInsnNode) node;
            if (BlockHelper.isBlacklistedClass(type.desc)) {
              plugin.addLog(
                  classNode.name + " -> Trying to create new instance of blacklisted class: "
                      + type.desc);
            }
          }
        }));
  }
}
